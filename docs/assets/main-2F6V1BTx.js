(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const y=11;function N(o){return o%2===0?6:5}const D=(()=>{const o=[0];for(let e=1;e<y;e++){const t=o[e-1];o.push(t+(e%2===1?4:3))}return o})();function B(o,e){return D[o]+e}function A(o,e,t=48){return t+B(o,e)}const P={portrait:{w:38,h:33}};function I(o,e,t=48){const n=P.portrait,i=e*n.w+(o%2?n.w/2:0)+t,r=(y-1-o)*n.h+t;return{x:i,y:r}}function C(o,e,t){return[[0,-t],[.866*t,-.5*t],[.866*t,.5*t],[0,+t],[-.866*t,.5*t],[-.866*t,-.5*t]].map(([i,r])=>`${o+i},${e+r}`).join(" ")}function x(o="portrait"){const e=P.portrait,t=6*e.w+120,n=y*e.h+120;return o==="portrait"?{width:t,height:n,viewBox:`0 0 ${t} ${n}`}:{width:n,height:t,viewBox:`0 0 ${n} ${t}`}}function O(o,e,t,n){const{x:i,y:r}=I(o,e),{x:a,y:c}=I(t,n);return Math.sqrt((a-i)**2+(c-r)**2)/P.portrait.w}const H={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11},L={maj:{name:"Major scale",intervals:[0,2,4,5,7,9,11],type:"scale"},natmin:{name:"Natural minor",intervals:[0,2,3,5,7,8,10],type:"scale"},harmin:{name:"Harmonic minor",intervals:[0,2,3,5,7,8,11],type:"scale"},melmin:{name:"Melodic minor",intervals:[0,2,3,5,7,9,11],type:"scale"},dorian:{name:"Dorian",intervals:[0,2,3,5,7,9,10],type:"scale"},phrygian:{name:"Phrygian",intervals:[0,1,3,5,7,8,10],type:"scale"},lydian:{name:"Lydian",intervals:[0,2,4,6,7,9,11],type:"scale"},mixolydian:{name:"Mixolydian",intervals:[0,2,4,5,7,9,10],type:"scale"},locrian:{name:"Locrian",intervals:[0,1,3,5,6,8,10],type:"scale"},majpent:{name:"Major pentatonic",intervals:[0,2,4,7,9],type:"scale"},minpent:{name:"Minor pentatonic",intervals:[0,3,5,7,10],type:"scale"},majtriad:{name:"Major triad",intervals:[0,4,7],type:"chord"},mintriad:{name:"Minor triad",intervals:[0,3,7],type:"chord"},augtriad:{name:"Augmented triad",intervals:[0,4,8],type:"chord"},dimtriad:{name:"Diminished triad",intervals:[0,3,6],type:"chord"},maj7:{name:"Major 7th",intervals:[0,4,7,11],type:"chord"},min7:{name:"Minor 7th",intervals:[0,3,7,10],type:"chord"},dom7:{name:"Dominant 7th",intervals:[0,4,7,10],type:"chord"},dim7:{name:"Diminished 7th",intervals:[0,3,6,9],type:"chord"},hdim7:{name:"Half-diminished 7th",intervals:[0,3,6,10],type:"chord"},maj9:{name:"Major 9th",intervals:[0,4,7,11,14],type:"chord"},min9:{name:"Minor 9th",intervals:[0,3,7,10,14],type:"chord"},dom9:{name:"Dominant 9th",intervals:[0,4,7,10,14],type:"chord"},chromatic:{name:"Chromatic",intervals:[0,1,2,3,4,5,6,7,8,9,10,11],type:"scale"},wholeTone:{name:"Whole tone",intervals:[0,2,4,6,8,10],type:"scale"}};function F(o,e){const t=H[o];if(t===void 0)throw new Error(`Invalid key: ${o}`);const n=L[e];if(!n)throw new Error(`Invalid set type: ${e}`);const i=new Set;for(const r of n.intervals)i.add((t+r)%12);return i}function T(o){const e=new Set;return!o||!o.trim()||o.split(",").forEach(t=>{const n=Number(t.trim());Number.isNaN(n)||e.add((n%12+12)%12)}),e}function b(o){return(o%12+12)%12}class R{constructor(e){this.svg=e,this.orientation="portrait",this.labelMode="pc",this.baseMidi=48,this.highlightedPCs=new Set,this.fingeringPattern=null,this.fingeringMode=!1,this.onPadClick=null}setOrientation(e){this.orientation=e}setLabelMode(e){this.labelMode=e}setBaseMidi(e){this.baseMidi=e}setHighlightedPCs(e){this.highlightedPCs=e}setFingeringPattern(e){this.fingeringPattern=e}setFingeringMode(e){this.fingeringMode=e}setPadClickHandler(e){this.onPadClick=e}render(){const e=x(this.orientation);this.svg.setAttribute("viewBox",e.viewBox),this.svg.innerHTML="";const t=document.createElementNS("http://www.w3.org/2000/svg","g");this.orientation==="landscape"&&t.setAttribute("transform",`translate(${e.width},0) rotate(90)`);for(let n=0;n<y;n++){const i=N(n);for(let r=0;r<i;r++)this._renderPad(t,n,r)}this.svg.appendChild(t)}_renderPad(e,t,n){const{x:i,y:r}=I(t,n),a=A(t,n,this.baseMidi),c=b(a),l=document.createElementNS("http://www.w3.org/2000/svg","polygon");if(l.setAttribute("points",C(i,r,22)),l.setAttribute("class","pad"),l.setAttribute("stroke","#666"),l.setAttribute("fill","#6aa5ff"),l.setAttribute("fill-opacity","0.12"),this.highlightedPCs.has(c)&&l.classList.add("on"),this.fingeringMode&&l.classList.add("fingering-mode"),l.addEventListener("click",()=>{this.onPadClick&&this.onPadClick(t,n,a,c)}),e.appendChild(l),this._renderLabel(e,i,r,a,c),this.fingeringPattern){const s=this.fingeringPattern.getFingering(t,n);s&&this._renderFingering(e,i,r,s)}}_renderLabel(e,t,n,i,r){const a=this._getLabelText(i,r),c=document.createElementNS("http://www.w3.org/2000/svg","text");c.setAttribute("x",t),c.setAttribute("y",n+4),c.setAttribute("text-anchor","middle"),c.setAttribute("class","label"),this.orientation==="landscape"&&c.setAttribute("transform",`rotate(-90 ${t} ${n})`),c.textContent=a,e.appendChild(c)}_renderFingering(e,t,n,i){const r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",t),r.setAttribute("y",n-8),r.setAttribute("text-anchor","middle"),r.setAttribute("class",`fing ${i.hand}`),this.orientation==="landscape"&&r.setAttribute("transform",`rotate(-90 ${t} ${n})`),r.textContent=i.finger,e.appendChild(r)}_getLabelText(e,t){switch(this.labelMode){case"pc":return t;case"note":return this._midiToNoteName(e);case"midi":return e;default:return t}}_midiToNoteName(e){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=b(e);return t[n]}}class ${constructor(){this.midiAccess=null,this.selectedOutput=null,this.isSupported=typeof navigator<"u"&&"requestMIDIAccess"in navigator,this.activeNotes=new Map,this.holdDuration=1e3,this.octaveRange=0,this.isHolding=!1}async init(){if(!this.isSupported)throw new Error("WebMIDI not supported in this browser");try{return this.midiAccess=await navigator.requestMIDIAccess(),this.midiAccess.onstatechange=()=>{this._onDeviceStateChange()},!0}catch(e){throw new Error(`MIDI initialization failed: ${e.message}`)}}getOutputDevices(){return this.midiAccess?Array.from(this.midiAccess.outputs.values()).map(e=>({id:e.id,name:e.name})):[]}selectOutputDevice(e){if(!this.midiAccess)return!1;const t=this.midiAccess.outputs.get(e);return t?(this.selectedOutput=t,!0):!1}setHoldDuration(e){this.holdDuration=Math.max(100,Math.min(e,3e4))}setOctaveRange(e){this.octaveRange=Math.max(0,Math.min(e,2))}noteOn(e,t=100){if(!(!this.selectedOutput||e<0||e>127))try{this.selectedOutput.send([144,e,t])}catch(n){console.error("MIDI send error:",n)}}noteOff(e){if(!(!this.selectedOutput||e<0||e>127))try{this.selectedOutput.send([128,e,0])}catch(t){console.error("MIDI send error:",t)}}playNote(e,t=100,n=null){const i=n!==null?n:this.holdDuration;this._getOctaveNotes(e).forEach(a=>{this.noteOn(a,t),this.isHolding?this.activeNotes.set(a,{velocity:t,time:Date.now()}):setTimeout(()=>{this.noteOff(a)},i)})}playChord(e,t=100,n=null,i=0){e.forEach((r,a)=>{setTimeout(()=>{this.playNote(r,t,n)},a*i)})}enableHold(){this.isHolding=!0,this.activeNotes.clear()}disableHold(){this.isHolding=!1,this.releaseAllNotes()}releaseAllNotes(){for(const[e]of this.activeNotes)this.noteOff(e);this.activeNotes.clear()}allNotesOff(){if(this.selectedOutput){try{for(let e=0;e<16;e++)this.selectedOutput.send([176+e,123,0])}catch(e){console.error("MIDI send error:",e)}this.activeNotes.clear()}}_getOctaveNotes(e){const t=[e];for(let n=1;n<=this.octaveRange;n++){const i=e+12*n,r=e-12*n;i<=127&&t.push(i),r>=0&&t.push(r)}return t}_onDeviceStateChange(){this.selectedOutput&&(this.midiAccess.outputs.get(this.selectedOutput.id)||(this.selectedOutput=null))}getStatus(){var e;return{isSupported:this.isSupported,isInitialized:this.midiAccess!==null,hasDevice:this.selectedOutput!==null,deviceName:((e=this.selectedOutput)==null?void 0:e.name)||null,isHolding:this.isHolding,activeNoteCount:this.activeNotes.size,holdDuration:this.holdDuration,octaveRange:this.octaveRange}}}const g=new $;class f{constructor(e="Untitled"){this.name=e,this.fingerings=new Map,this.metadata={key:null,setType:null,baseMidi:48,createdAt:Date.now(),modifiedAt:Date.now()}}setFingering(e,t,n,i){const r=`${e},${t}`;this.fingerings.set(r,{hand:n,finger:i}),this.metadata.modifiedAt=Date.now()}getFingering(e,t){const n=`${e},${t}`;return this.fingerings.get(n)||null}removeFingering(e,t){const n=`${e},${t}`;this.fingerings.delete(n),this.metadata.modifiedAt=Date.now()}clearAll(){this.fingerings.clear(),this.metadata.modifiedAt=Date.now()}getPadsForHand(e){const t=[];for(const[n,i]of this.fingerings)if(i.hand===e){const[r,a]=n.split(",").map(Number);t.push({row:r,col:a,finger:i.finger})}return t}getPadsForFinger(e,t=null){const n=[];for(const[i,r]of this.fingerings)if(r.finger===e&&(!t||r.hand===t)){const[a,c]=i.split(",").map(Number);n.push({row:a,col:c,hand:r.hand})}return n}toJSON(){return{name:this.name,fingerings:Array.from(this.fingerings.entries()),metadata:this.metadata}}static fromJSON(e){const t=new f(e.name);return t.fingerings=new Map(e.fingerings),t.metadata=e.metadata,t}}class k{constructor(){this.fingerWeights={1:.8,2:1,3:.9,4:.6,5:.4},this.handSizes={small:{maxStretch:2.5,comfortableStretch:1.5},medium:{maxStretch:3,comfortableStretch:2},large:{maxStretch:3.5,comfortableStretch:2.5}},this.currentHandSize="medium"}setHandSize(e){this.handSizes[e]&&(this.currentHandSize=e)}analyzePattern(e){let t=100;const n=[];return["left","right"].forEach(i=>{const r=e.getPadsForHand(i);if(r.length===0)return;const a=this._analyzeSpan(r,i,n);t-=a;const c=this._analyzeFingerStrength(r,n);t+=c;const l=this._analyzeFingerCrossings(r,i,n);t-=l}),{score:Math.max(0,Math.min(100,t)),issues:n,recommendation:this._getRecommendation(t)}}suggestFingerings(e,t,n=48){if(e.length===0)return[];const i=new Map;e.forEach(c=>{const l=c.row===0?c.col:(c.row%2===1?4:3)*c.row+c.col,s=n+l,d=s%12;if(!i.has(d))i.set(d,{...c,pc:d,midiNote:s});else{const u=i.get(d);(c.row<u.row||c.row===u.row&&c.col<u.col)&&i.set(d,{...c,pc:d,midiNote:s})}});const r=Array.from(i.values());let a=r;return r.length>5&&(a=[...r].sort((c,l)=>{const s=c.row*2+c.col,d=l.row*2+l.col;return s-d}).slice(0,5)),this._assignFingersAnatomically(a,t)}_assignFingersAnatomically(e,t){if(e.length===0)return[];const i=[...e].sort((s,d)=>s.row!==d.row?s.row-d.row:t==="right"?s.col-d.col:d.col-s.col)[0],r=[];r.push({row:i.row,col:i.col,hand:t,finger:1,score:1});const a=e.filter(s=>!(s.row===i.row&&s.col===i.col));if(a.length===0)return r;const c=a.map(s=>{const d=s.row-i.row,u=s.col-i.col,E=Math.sqrt(d*d+u*u),S=t==="right"?d+u:d-u;return{pad:s,distance:E,directionScore:S,score:S*2-E*.5}}).sort((s,d)=>d.score-s.score),l=[2,3,4,5];return c.slice(0,4).forEach((s,d)=>{r.push({row:s.pad.row,col:s.pad.col,hand:t,finger:l[d],score:.8})}),r}_analyzeSpan(e,t,n){const i=this.handSizes[this.currentHandSize];let r=0;const a=[...e].sort((c,l)=>c.finger-l.finger);for(let c=0;c<a.length-1;c++){const l=a[c],s=a[c+1];if(l.finger===s.finger)continue;const d=O(l.row,l.col,s.row,s.col);d>i.maxStretch?(r+=20,n.push({type:"excessive_stretch",hand:t,fingers:[l.finger,s.finger],distance:d})):d>i.comfortableStretch&&(r+=5,n.push({type:"uncomfortable_stretch",hand:t,fingers:[l.finger,s.finger],distance:d}))}return r}_analyzeFingerStrength(e,t){let n=0;return e.forEach(i=>{const r=this.fingerWeights[i.finger];r>=.9?n+=2:r<=.5&&(n-=1)}),n}_analyzeFingerCrossings(e,t,n){let i=0;const r=new Set,a=[...e].sort((c,l)=>c.finger-l.finger);for(let c=0;c<a.length-1;c++){const l=a[c],s=a[c+1],d=`${l.finger}-${s.finger}`;r.has(d)||l.row>s.row&&(i+=5,r.add(d),n.push({type:"finger_crossing",hand:t,fingers:[l.finger,s.finger]}))}return i}_getRecommendation(e){return e>=90?"Excellent ergonomics!":e>=75?"Good fingering, comfortable to play":e>=60?"Acceptable, but could be improved":e>=40?"Uncomfortable, consider revising":"Poor ergonomics, recommend different fingering"}_suggestMultiHandFingering(e){const t=Math.floor(e.length/2),n=e.slice(0,t),i=e.slice(t);return[...this.suggestFingerings(n,"left"),...this.suggestFingerings(i,"right")]}}const p=new k,h={PATTERNS:"exquisPatterns",SETTINGS:"exquisSettings",RECENT_PATTERNS:"exquisRecentPatterns"};function _(o,e){const t=v();t[o]={...e,savedAt:Date.now()},localStorage.setItem(h.PATTERNS,JSON.stringify(t)),G(o)}function z(o){return v()[o]||null}function j(o){const e=v();return e[o]?(delete e[o],localStorage.setItem(h.PATTERNS,JSON.stringify(e)),U(o),!0):!1}function v(){try{const o=localStorage.getItem(h.PATTERNS);return o?JSON.parse(o):{}}catch(o){return console.error("Error loading patterns:",o),{}}}function J(){return Object.keys(v()).sort()}function m(o){localStorage.setItem(h.SETTINGS,JSON.stringify(o))}function q(){try{const o=localStorage.getItem(h.SETTINGS);return o?JSON.parse(o):M()}catch(o){return console.error("Error loading settings:",o),M()}}function M(){return{orientation:"portrait",labelMode:"pc",baseMidi:48,midiHoldDuration:1e3,midiOctaveRange:0,handSize:"medium",theme:"light"}}function G(o){let e=w();e=e.filter(t=>t!==o),e.unshift(o),e=e.slice(0,10),localStorage.setItem(h.RECENT_PATTERNS,JSON.stringify(e))}function U(o){let e=w();e=e.filter(t=>t!==o),localStorage.setItem(h.RECENT_PATTERNS,JSON.stringify(e))}function w(){try{const o=localStorage.getItem(h.RECENT_PATTERNS);return o?JSON.parse(o):[]}catch{return[]}}class W{constructor(){this.settings=q(),this.currentPattern=new f,this.currentFinger=1,this.currentHand="right",this.fingeringMode=!1,this.gridElement=document.getElementById("grid"),this.gridRenderer=new R(this.gridElement),this.initUI(),this.loadStoredSettings(),this.updatePatternMetadata(),this.render()}initUI(){var a,c,l;document.querySelectorAll('input[name="ori"]').forEach(s=>{s.addEventListener("change",()=>{this.settings.orientation=s.value,this.render(),m(this.settings)})}),document.querySelectorAll('input[name="lab"]').forEach(s=>{s.addEventListener("change",()=>{this.settings.labelMode=s.value,this.render(),m(this.settings)})}),document.getElementById("key").addEventListener("change",()=>{this.updatePatternMetadata(),this.render(),this.updateMIDIHoldIfActive()}),document.getElementById("set").addEventListener("change",s=>{const d=s.target.value==="custom";document.getElementById("customPC").disabled=!d,this.updatePatternMetadata(),this.render(),this.updateMIDIHoldIfActive()}),document.getElementById("customPC").addEventListener("input",()=>{this.render(),this.updateMIDIHoldIfActive()}),document.getElementById("baseMidi").addEventListener("input",s=>{this.settings.baseMidi=parseInt(s.target.value),this.render(),this.updateMIDIHoldIfActive(),m(this.settings)}),document.getElementById("fingeringMode").addEventListener("change",s=>{this.fingeringMode=s.target.checked,document.getElementById("fingeringModeInfo").style.display=this.fingeringMode?"block":"none",document.querySelectorAll(".finger-btn").forEach(d=>{d.disabled=!this.fingeringMode}),this.render()}),document.getElementById("fingeringHand").addEventListener("change",s=>{this.currentHand=s.target.value});for(let s=1;s<=5;s++)document.getElementById(`fingBtn${s}`).addEventListener("click",()=>{this.currentFinger=s,this.updateFingerButtonState()});document.addEventListener("keydown",s=>{this.fingeringMode&&s.key>="1"&&s.key<="5"&&(this.currentFinger=parseInt(s.key),this.updateFingerButtonState())}),document.getElementById("clearFingerings").addEventListener("click",()=>{this.currentPattern.clearAll(),this.render()}),document.getElementById("suggestFingerings").addEventListener("click",()=>{this.suggestFingerings()}),document.getElementById("savePattern").addEventListener("click",()=>this.saveCurrentPattern()),document.getElementById("loadPattern").addEventListener("change",s=>{s.target.value&&this.loadPatternByName(s.target.value)}),document.getElementById("deletePattern").addEventListener("click",()=>this.deleteCurrentPattern()),document.getElementById("exportPattern").addEventListener("click",()=>this.exportPattern()),document.getElementById("importPatternBtn").addEventListener("click",()=>{document.getElementById("importPattern").click()}),document.getElementById("importPattern").addEventListener("change",s=>this.importPattern(s)),document.getElementById("enableMidi").addEventListener("click",()=>this.initMIDI()),document.getElementById("midiDevice").addEventListener("change",s=>{s.target.value&&(g.selectOutputDevice(s.target.value),this.updateMIDIStatus())});const e=document.getElementById("midiHoldDuration"),t=document.getElementById("holdDurationValue");e==null||e.addEventListener("input",s=>{const d=parseInt(s.target.value);t.textContent=`${(d/1e3).toFixed(1)}s`,g.setHoldDuration(d),this.settings.midiHoldDuration=d,m(this.settings)});const n=document.getElementById("midiOctaveRange"),i=document.getElementById("octaveRangeValue");n==null||n.addEventListener("input",s=>{const d=parseInt(s.target.value);i.textContent=d===0?"0 (none)":`±${d}`,g.setOctaveRange(d),this.settings.midiOctaveRange=d,m(this.settings)});const r=document.getElementById("midiHoldToggle");r==null||r.addEventListener("change",s=>{s.target.checked?(g.enableHold(),this.sendHighlightedNotes()):g.disableHold()}),(a=document.getElementById("midiSendHighlighted"))==null||a.addEventListener("click",()=>{this.sendHighlightedNotes()}),(c=document.getElementById("analyzeErgo"))==null||c.addEventListener("click",()=>{this.analyzeErgonomics()}),(l=document.getElementById("handSize"))==null||l.addEventListener("change",s=>{p.setHandSize(s.target.value),this.settings.handSize=s.target.value,m(this.settings)}),this.gridRenderer.setPadClickHandler((s,d,u,E)=>{this.fingeringMode?this.handleFingeringClick(s,d):g.playNote(u)})}loadStoredSettings(){document.querySelector(`input[name="ori"][value="${this.settings.orientation}"]`).checked=!0,document.querySelector(`input[name="lab"][value="${this.settings.labelMode}"]`).checked=!0,document.getElementById("baseMidi").value=this.settings.baseMidi;const e=document.getElementById("midiHoldDuration");e&&(e.value=this.settings.midiHoldDuration,document.getElementById("holdDurationValue").textContent=`${(this.settings.midiHoldDuration/1e3).toFixed(1)}s`,g.setHoldDuration(this.settings.midiHoldDuration));const t=document.getElementById("midiOctaveRange");if(t){t.value=this.settings.midiOctaveRange;const i=this.settings.midiOctaveRange;document.getElementById("octaveRangeValue").textContent=i===0?"0 (none)":`±${i}`,g.setOctaveRange(i)}const n=document.getElementById("handSize");n&&(n.value=this.settings.handSize,p.setHandSize(this.settings.handSize)),this.updatePatternList()}render(){this.gridRenderer.setOrientation(this.settings.orientation),this.gridRenderer.setLabelMode(this.settings.labelMode),this.gridRenderer.setBaseMidi(this.settings.baseMidi),this.gridRenderer.setHighlightedPCs(this.getHighlightedPCs()),this.gridRenderer.setFingeringPattern(this.currentPattern),this.gridRenderer.setFingeringMode(this.fingeringMode),this.gridRenderer.render()}getHighlightedPCs(){const e=document.getElementById("set").value;if(e==="custom"){const t=document.getElementById("customPC").value;return T(t)}else{const t=document.getElementById("key").value;return F(t,e)}}handleFingeringClick(e,t){const n=this.currentPattern.getFingering(e,t);n&&n.hand===this.currentHand&&n.finger===this.currentFinger?this.currentPattern.removeFingering(e,t):this.currentPattern.setFingering(e,t,this.currentHand,this.currentFinger),this.render()}updateFingerButtonState(){for(let e=1;e<=5;e++){const t=document.getElementById(`fingBtn${e}`);t.style.opacity=e===this.currentFinger?"1":"0.5"}}suggestFingerings(){const e=this.getHighlightedPCs();if(e.size===0){alert("No notes highlighted. Please select a key and scale/chord first.");return}const t=[];for(let a=0;a<11;a++)for(let c=0;c<(a%2===0?6:5);c++){const l=a===0?c:(a%2===1?4:3)*a+c,d=(this.settings.baseMidi+l)%12;e.has(d)&&t.push({row:a,col:c})}if(t.length===0){alert("No pads match the selected notes in the current range.");return}const n=document.getElementById("fingeringHand").value,i=p.suggestFingerings(t,n,this.settings.baseMidi);this.currentPattern.getPadsForHand(n).forEach(a=>{this.currentPattern.removeFingering(a.row,a.col)}),i.forEach(a=>{this.currentPattern.setFingering(a.row,a.col,a.hand,a.finger)}),this.render(),alert(`Suggested fingerings for ${i.length} pads (${n} hand)`)}saveCurrentPattern(){const e=document.getElementById("patternName").value.trim();if(!e){alert("Please enter a pattern name");return}const t={...this.currentPattern.toJSON(),key:document.getElementById("key").value,set:document.getElementById("set").value,baseMidi:this.settings.baseMidi};_(e,t),this.updatePatternList(),document.getElementById("patternName").value="",alert(`Pattern "${e}" saved!`)}loadPatternByName(e){const t=z(e);if(!t){alert(`Pattern "${e}" not found`);return}this.currentPattern=f.fromJSON(t),document.getElementById("key").value=t.key,document.getElementById("set").value=t.set,this.settings.baseMidi=t.baseMidi,document.getElementById("baseMidi").value=t.baseMidi,this.render()}deleteCurrentPattern(){const e=document.getElementById("loadPattern").value;if(!e){alert("Please select a pattern to delete");return}confirm(`Delete pattern "${e}"?`)&&(j(e),this.updatePatternList(),document.getElementById("loadPattern").value="")}exportPattern(){if(this.currentPattern.fingerings.size===0){alert("No fingerings to export. Create a fingering pattern first.");return}this.updatePatternMetadata();const e=document.getElementById("patternName");e.value.trim()&&(this.currentPattern.name=e.value.trim());let t;if(this.currentPattern.name==="Untitled"||!this.currentPattern.name.trim()){const c=this.currentPattern.metadata.key||"C",l=this.currentPattern.metadata.setType||"major",s=this.currentHand||"right";t=`${c}_${l}_${s}`}else t=this.currentPattern.name;const n=JSON.stringify(this.currentPattern.toJSON(),null,2),i=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(i),a=document.createElement("a");a.href=r,a.download=`${t.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),alert(`Exported "${this.currentPattern.name}" to JSON file`)}importPattern(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=i=>{try{const r=JSON.parse(i.target.result),a=f.fromJSON(r);this.currentPattern=a,document.getElementById("patternName").value=a.name,this.render(),alert(`Imported "${a.name}" with ${a.fingerings.size} fingerings`),e.target.value=""}catch(r){alert(`Error importing file: ${r.message}`),console.error("Import error:",r)}},n.readAsText(t)}updatePatternList(){const e=document.getElementById("loadPattern"),t=J();e.innerHTML='<option value="">-- Select Pattern --</option>',t.forEach(n=>{const i=document.createElement("option");i.value=n,i.textContent=n,e.appendChild(i)})}async initMIDI(){try{await g.init(),this.updateMIDIDeviceList(),this.updateMIDIStatus()}catch(e){this.updateMIDIStatus(e.message)}}updateMIDIDeviceList(){const e=document.getElementById("midiDevice"),t=g.getOutputDevices();e.innerHTML='<option value="">-- Select device --</option>',t.forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.name,e.appendChild(i)}),e.disabled=t.length===0}updateMIDIStatus(e=null){const t=g.getStatus(),n=document.getElementById("midiStatus");e?(n.textContent=`Error: ${e}`,n.className="error-box"):t.isSupported?t.isInitialized?t.hasDevice?(n.textContent=`Connected: ${t.deviceName}`,n.className="success-box"):(n.textContent="MIDI ready - select a device",n.className="info-box"):(n.textContent="MIDI not initialized",n.className="warning-box"):(n.textContent="WebMIDI not supported (use Chrome/Brave/Edge)",n.className="warning-box")}sendHighlightedNotes(){const e=this.getHighlightedPCs(),t=[];for(let n=0;n<39;n++){const i=this.settings.baseMidi+n,r=i%12;e.has(r)&&t.push(i)}g.playChord(t,100,null,20)}updatePatternMetadata(){const e=document.getElementById("key").value,t=document.getElementById("set").value;this.currentPattern.metadata.key=e,this.currentPattern.metadata.setType=t,this.currentPattern.metadata.modifiedAt=Date.now()}updateMIDIHoldIfActive(){const e=document.getElementById("midiHoldToggle");e&&e.checked&&g.getStatus().isHolding&&(g.releaseAllNotes(),this.sendHighlightedNotes())}analyzeErgonomics(){const e=p.analyzePattern(this.currentPattern),t=document.getElementById("ergoResult");t&&(t.innerHTML=`
        <div class="score-display">
          <div class="score-label">Ergonomic Score</div>
          <div class="score-value">${e.score}</div>
          <div class="score-recommendation">${e.recommendation}</div>
        </div>
        ${e.issues.length>0?`
          <h4>Issues Found:</h4>
          <ul class="issue-list">
            ${e.issues.map(n=>`<li class="issue-item">${this.formatIssue(n)}</li>`).join("")}
          </ul>
        `:'<div class="success-box">No ergonomic issues found!</div>'}
      `)}formatIssue(e){switch(e.type){case"excessive_stretch":return`Excessive stretch between fingers ${e.fingers.join(" and ")} (${e.hand} hand)`;case"uncomfortable_stretch":return`Uncomfortable stretch between fingers ${e.fingers.join(" and ")} (${e.hand} hand)`;case"finger_crossing":return`Possible finger crossing: fingers ${e.fingers.join(" and ")} (${e.hand} hand)`;default:return JSON.stringify(e)}}}document.addEventListener("DOMContentLoaded",()=>{window.app=new W});
