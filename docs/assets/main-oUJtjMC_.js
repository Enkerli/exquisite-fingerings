(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();const S=11;function N(o){return o%2===0?6:5}const D=(()=>{const o=[0];for(let t=1;t<S;t++){const e=o[t-1];o.push(e+(t%2===1?4:3))}return o})();function B(o,t){return D[o]+t}function A(o,t,e=48){return e+B(o,t)}const C={portrait:{w:38,h:33}};function P(o,t,e=48){const n=C.portrait,i=t*n.w+(o%2?n.w/2:0)+e,s=(S-1-o)*n.h+e;return{x:i,y:s}}function L(o,t,e){return[[0,-e],[.866*e,-.5*e],[.866*e,.5*e],[0,+e],[-.866*e,.5*e],[-.866*e,-.5*e]].map(([i,s])=>`${o+i},${t+s}`).join(" ")}function O(o="portrait"){const t=C.portrait,e=6*t.w+120,n=S*t.h+120;return o==="portrait"?{width:e,height:n,viewBox:`0 0 ${e} ${n}`}:{width:n,height:e,viewBox:`0 0 ${n} ${e}`}}function $(o,t,e,n){const{x:i,y:s}=P(o,t),{x:r,y:a}=P(e,n);return Math.sqrt((r-i)**2+(a-s)**2)/C.portrait.w}const T={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11},k={maj:{name:"Major scale",intervals:[0,2,4,5,7,9,11],type:"scale"},natmin:{name:"Natural minor",intervals:[0,2,3,5,7,8,10],type:"scale"},harmin:{name:"Harmonic minor",intervals:[0,2,3,5,7,8,11],type:"scale"},melmin:{name:"Melodic minor",intervals:[0,2,3,5,7,9,11],type:"scale"},dorian:{name:"Dorian",intervals:[0,2,3,5,7,9,10],type:"scale"},phrygian:{name:"Phrygian",intervals:[0,1,3,5,7,8,10],type:"scale"},lydian:{name:"Lydian",intervals:[0,2,4,6,7,9,11],type:"scale"},mixolydian:{name:"Mixolydian",intervals:[0,2,4,5,7,9,10],type:"scale"},locrian:{name:"Locrian",intervals:[0,1,3,5,6,8,10],type:"scale"},majpent:{name:"Major pentatonic",intervals:[0,2,4,7,9],type:"scale"},minpent:{name:"Minor pentatonic",intervals:[0,3,5,7,10],type:"scale"},majtriad:{name:"Major triad",intervals:[0,4,7],type:"chord"},mintriad:{name:"Minor triad",intervals:[0,3,7],type:"chord"},augtriad:{name:"Augmented triad",intervals:[0,4,8],type:"chord"},dimtriad:{name:"Diminished triad",intervals:[0,3,6],type:"chord"},maj7:{name:"Major 7th",intervals:[0,4,7,11],type:"chord"},min7:{name:"Minor 7th",intervals:[0,3,7,10],type:"chord"},dom7:{name:"Dominant 7th",intervals:[0,4,7,10],type:"chord"},dim7:{name:"Diminished 7th",intervals:[0,3,6,9],type:"chord"},hdim7:{name:"Half-diminished 7th",intervals:[0,3,6,10],type:"chord"},maj9:{name:"Major 9th",intervals:[0,4,7,11,14],type:"chord"},min9:{name:"Minor 9th",intervals:[0,3,7,10,14],type:"chord"},dom9:{name:"Dominant 9th",intervals:[0,4,7,10,14],type:"chord"},chromatic:{name:"Chromatic",intervals:[0,1,2,3,4,5,6,7,8,9,10,11],type:"scale"},wholeTone:{name:"Whole tone",intervals:[0,2,4,6,8,10],type:"scale"}};function R(o,t){const e=T[o];if(e===void 0)throw new Error(`Invalid key: ${o}`);const n=k[t];if(!n)throw new Error(`Invalid set type: ${t}`);const i=new Set;for(const s of n.intervals)i.add((e+s)%12);return i}function F(o){const t=new Set;return!o||!o.trim()||o.split(",").forEach(e=>{const n=Number(e.trim());Number.isNaN(n)||t.add((n%12+12)%12)}),t}function M(o){return(o%12+12)%12}class _{constructor(t){this.svg=t,this.orientation="portrait",this.labelMode="pc",this.baseMidi=48,this.highlightedPCs=new Set,this.fingeringPattern=null,this.fingeringMode=!1,this.onPadClick=null}setOrientation(t){this.orientation=t}setLabelMode(t){this.labelMode=t}setBaseMidi(t){this.baseMidi=t}setHighlightedPCs(t){this.highlightedPCs=t}setFingeringPattern(t){this.fingeringPattern=t}setFingeringMode(t){this.fingeringMode=t}setPadClickHandler(t){this.onPadClick=t}render(){const t=O(this.orientation);this.svg.setAttribute("viewBox",t.viewBox),this.svg.innerHTML="";const e=document.createElementNS("http://www.w3.org/2000/svg","g");this.orientation==="landscape"&&e.setAttribute("transform",`translate(${t.width},0) rotate(90)`);for(let n=0;n<S;n++){const i=N(n);for(let s=0;s<i;s++)this._renderPad(e,n,s)}this.svg.appendChild(e)}_renderPad(t,e,n){const{x:i,y:s}=P(e,n),r=A(e,n,this.baseMidi),a=M(r),l=document.createElementNS("http://www.w3.org/2000/svg","polygon");if(l.setAttribute("points",L(i,s,22)),l.setAttribute("class","pad"),l.setAttribute("stroke","#666"),l.setAttribute("fill","#6aa5ff"),l.setAttribute("fill-opacity","0.12"),this.highlightedPCs.has(a)&&l.classList.add("on"),this.fingeringMode&&l.classList.add("fingering-mode"),l.addEventListener("click",()=>{this.onPadClick&&this.onPadClick(e,n,r,a)}),t.appendChild(l),this._renderLabel(t,i,s,r,a),this.fingeringPattern){const d=this.fingeringPattern.getFingering(e,n);d&&this._renderFingering(t,i,s,d)}}_renderLabel(t,e,n,i,s){const r=this._getLabelText(i,s),a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",e),a.setAttribute("y",n+4),a.setAttribute("text-anchor","middle"),a.setAttribute("class","label"),this.orientation==="landscape"&&a.setAttribute("transform",`rotate(-90 ${e} ${n})`),a.textContent=r,t.appendChild(a)}_renderFingering(t,e,n,i){const s=document.createElementNS("http://www.w3.org/2000/svg","text");s.setAttribute("x",e),s.setAttribute("y",n-8),s.setAttribute("text-anchor","middle"),s.setAttribute("class",`fing ${i.hand}`),this.orientation==="landscape"&&s.setAttribute("transform",`rotate(-90 ${e} ${n})`),s.textContent=i.finger,t.appendChild(s)}_getLabelText(t,e){switch(this.labelMode){case"pc":return e;case"note":return this._midiToNoteName(t);case"midi":return t;default:return e}}_midiToNoteName(t){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=M(t);return e[n]}}class z{constructor(){this.midiAccess=null,this.selectedOutput=null,this.isSupported=typeof navigator<"u"&&"requestMIDIAccess"in navigator,this.activeNotes=new Map,this.holdDuration=1e3,this.octaveRange=0,this.isHolding=!1}async init(){if(!this.isSupported)throw new Error("WebMIDI not supported in this browser");try{return this.midiAccess=await navigator.requestMIDIAccess(),this.midiAccess.onstatechange=()=>{this._onDeviceStateChange()},!0}catch(t){throw new Error(`MIDI initialization failed: ${t.message}`)}}getOutputDevices(){return this.midiAccess?Array.from(this.midiAccess.outputs.values()).map(t=>({id:t.id,name:t.name})):[]}selectOutputDevice(t){if(!this.midiAccess)return!1;const e=this.midiAccess.outputs.get(t);return e?(this.selectedOutput=e,!0):!1}setHoldDuration(t){this.holdDuration=Math.max(100,Math.min(t,3e4))}setOctaveRange(t){this.octaveRange=Math.max(0,Math.min(t,2))}noteOn(t,e=100){if(!(!this.selectedOutput||t<0||t>127))try{this.selectedOutput.send([144,t,e])}catch(n){console.error("MIDI send error:",n)}}noteOff(t){if(!(!this.selectedOutput||t<0||t>127))try{this.selectedOutput.send([128,t,0])}catch(e){console.error("MIDI send error:",e)}}playNote(t,e=100,n=null){const i=n!==null?n:this.holdDuration;this._getOctaveNotes(t).forEach(r=>{this.noteOn(r,e),this.isHolding?this.activeNotes.set(r,{velocity:e,time:Date.now()}):setTimeout(()=>{this.noteOff(r)},i)})}playChord(t,e=100,n=null,i=0){t.forEach((s,r)=>{setTimeout(()=>{this.playNote(s,e,n)},r*i)})}enableHold(){this.isHolding=!0,this.activeNotes.clear()}disableHold(){this.isHolding=!1,this.releaseAllNotes()}releaseAllNotes(){for(const[t]of this.activeNotes)this.noteOff(t);this.activeNotes.clear()}allNotesOff(){if(this.selectedOutput){try{for(let t=0;t<16;t++)this.selectedOutput.send([176+t,123,0])}catch(t){console.error("MIDI send error:",t)}this.activeNotes.clear()}}_getOctaveNotes(t){const e=[t];for(let n=1;n<=this.octaveRange;n++){const i=t+12*n,s=t-12*n;i<=127&&e.push(i),s>=0&&e.push(s)}return e}_onDeviceStateChange(){this.selectedOutput&&(this.midiAccess.outputs.get(this.selectedOutput.id)||(this.selectedOutput=null))}setNoteHandler(t){if(this.noteHandler=t,this.midiAccess){const e=this.midiAccess.inputs.values();for(const n of e)t?n.onmidimessage=i=>this._handleMidiInput(i):n.onmidimessage=null}}_handleMidiInput(t){const[e,n,i]=t.data,s=e&240;if(s===144||s===128){const r=s===128?0:i;this.noteHandler&&this.noteHandler(n,r)}}getStatus(){var e;const t={isSupported:this.isSupported,isInitialized:this.midiAccess!==null,hasDevice:this.selectedOutput!==null,deviceName:((e=this.selectedOutput)==null?void 0:e.name)||null,isHolding:this.isHolding,activeNoteCount:this.activeNotes.size,holdDuration:this.holdDuration,octaveRange:this.octaveRange};return t.isEnabled=t.isInitialized,t}_oldGetStatus(){var t;return{isSupported:this.isSupported,isInitialized:this.midiAccess!==null,hasDevice:this.selectedOutput!==null,deviceName:((t=this.selectedOutput)==null?void 0:t.name)||null,isHolding:this.isHolding,activeNoteCount:this.activeNotes.size,holdDuration:this.holdDuration,octaveRange:this.octaveRange}}}const g=new z;class E{constructor(t="Untitled"){this.name=t,this.fingerings=new Map,this.metadata={key:null,setType:null,baseMidi:48,createdAt:Date.now(),modifiedAt:Date.now()}}setFingering(t,e,n,i){const s=`${t},${e}`;this.fingerings.set(s,{hand:n,finger:i}),this.metadata.modifiedAt=Date.now()}getFingering(t,e){const n=`${t},${e}`;return this.fingerings.get(n)||null}removeFingering(t,e){const n=`${t},${e}`;this.fingerings.delete(n),this.metadata.modifiedAt=Date.now()}clearAll(){this.fingerings.clear(),this.metadata.modifiedAt=Date.now()}getPadsForHand(t){const e=[];for(const[n,i]of this.fingerings)if(i.hand===t){const[s,r]=n.split(",").map(Number);e.push({row:s,col:r,finger:i.finger})}return e}getPadsForFinger(t,e=null){const n=[];for(const[i,s]of this.fingerings)if(s.finger===t&&(!e||s.hand===e)){const[r,a]=i.split(",").map(Number);n.push({row:r,col:a,hand:s.hand})}return n}toJSON(){return{name:this.name,fingerings:Array.from(this.fingerings.entries()),metadata:this.metadata}}static fromJSON(t){const e=new E(t.name);return e.fingerings=new Map(t.fingerings),e.metadata=t.metadata,e}}class j{constructor(){this.fingerWeights={1:.8,2:1,3:.9,4:.6,5:.4},this.handSizes={small:{maxStretch:2.5,comfortableStretch:1.5},medium:{maxStretch:3,comfortableStretch:2},large:{maxStretch:3.5,comfortableStretch:2.5}},this.currentHandSize="medium"}setHandSize(t){t==="custom"?this.currentHandSize="custom":this.handSizes[t]&&(this.currentHandSize=t)}setCustomHandprint(t){const e=Object.values(t),n=Math.max(...e),i=e.reduce((s,r)=>s+r,0)/e.length;this.handSizes.custom={maxStretch:n*1.1,comfortableStretch:i,measurements:t},this.currentHandSize="custom"}analyzePattern(t){let e=100;const n=[];return["left","right"].forEach(i=>{const s=t.getPadsForHand(i);if(s.length===0)return;const r=this._analyzeSpan(s,i,n);e-=r;const a=this._analyzeFingerStrength(s,n);e+=a;const l=this._analyzeFingerCrossings(s,i,n);e-=l}),{score:Math.max(0,Math.min(100,e)),issues:n,recommendation:this._getRecommendation(e)}}suggestFingerings(t,e,n=48){if(t.length===0)return[];const i=new Map;t.forEach(a=>{const l=a.row===0?a.col:(a.row%2===1?4:3)*a.row+a.col,d=n+l,u=d%12;if(!i.has(u))i.set(u,{...a,pc:u,midiNote:d});else{const m=i.get(u);(a.row<m.row||a.row===m.row&&a.col<m.col)&&i.set(u,{...a,pc:u,midiNote:d})}});const s=Array.from(i.values());let r=s;return s.length>5&&(r=[...s].sort((a,l)=>{const d=a.row*2+a.col,u=l.row*2+l.col;return d-u}).slice(0,5)),this._assignFingersAnatomically(r,e)}_assignFingersAnatomically(t,e){if(t.length===0)return[];const i=[...t].sort((d,u)=>d.row!==u.row?d.row-u.row:e==="right"?d.col-u.col:u.col-d.col)[0],s=[];s.push({row:i.row,col:i.col,hand:e,finger:1,score:1});const r=t.filter(d=>!(d.row===i.row&&d.col===i.col));if(r.length===0)return s;const a=r.map(d=>{const u=d.row-i.row,m=d.col-i.col,v=Math.sqrt(u*u+m*m),y=e==="right"?u+m:u-m;return{pad:d,distance:v,directionScore:y,score:y*2-v*.5}}).sort((d,u)=>u.score-d.score),l=[2,3,4,5];return a.slice(0,4).forEach((d,u)=>{s.push({row:d.pad.row,col:d.pad.col,hand:e,finger:l[u],score:.8})}),s}_analyzeSpan(t,e,n){const i=this.handSizes[this.currentHandSize];let s=0;const r=[...t].sort((a,l)=>a.finger-l.finger);for(let a=0;a<r.length-1;a++){const l=r[a],d=r[a+1];if(l.finger===d.finger)continue;const u=$(l.row,l.col,d.row,d.col);u>i.maxStretch?(s+=20,n.push({type:"excessive_stretch",hand:e,fingers:[l.finger,d.finger],distance:u})):u>i.comfortableStretch&&(s+=5,n.push({type:"uncomfortable_stretch",hand:e,fingers:[l.finger,d.finger],distance:u}))}return s}_analyzeFingerStrength(t,e){let n=0;return t.forEach(i=>{const s=this.fingerWeights[i.finger];s>=.9?n+=2:s<=.5&&(n-=1)}),n}_analyzeFingerCrossings(t,e,n){let i=0;const s=new Set,r=[...t].sort((a,l)=>a.finger-l.finger);for(let a=0;a<r.length-1;a++){const l=r[a],d=r[a+1],u=`${l.finger}-${d.finger}`;s.has(u)||l.row>d.row&&(i+=5,s.add(u),n.push({type:"finger_crossing",hand:e,fingers:[l.finger,d.finger]}))}return i}_getRecommendation(t){return t>=90?"Excellent ergonomics!":t>=75?"Good fingering, comfortable to play":t>=60?"Acceptable, but could be improved":t>=40?"Uncomfortable, consider revising":"Poor ergonomics, recommend different fingering"}_suggestMultiHandFingering(t){const e=Math.floor(t.length/2),n=t.slice(0,e),i=t.slice(e);return[...this.suggestFingerings(n,"left"),...this.suggestFingerings(i,"right")]}}const I=new j,f={PATTERNS:"exquisPatterns",SETTINGS:"exquisSettings",RECENT_PATTERNS:"exquisRecentPatterns"};function J(o,t){const e=b();e[o]={...t,savedAt:Date.now()},localStorage.setItem(f.PATTERNS,JSON.stringify(e)),W(o)}function q(o){return b()[o]||null}function U(o){const t=b();return t[o]?(delete t[o],localStorage.setItem(f.PATTERNS,JSON.stringify(t)),K(o),!0):!1}function b(){try{const o=localStorage.getItem(f.PATTERNS);return o?JSON.parse(o):{}}catch(o){return console.error("Error loading patterns:",o),{}}}function G(){return Object.keys(b()).sort()}function p(o){localStorage.setItem(f.SETTINGS,JSON.stringify(o))}function V(){try{const o=localStorage.getItem(f.SETTINGS);return o?JSON.parse(o):H()}catch(o){return console.error("Error loading settings:",o),H()}}function H(){return{orientation:"portrait",labelMode:"pc",baseMidi:48,midiHoldDuration:1e3,midiOctaveRange:0,handSize:"medium",theme:"light"}}function W(o){let t=w();t=t.filter(e=>e!==o),t.unshift(o),t=t.slice(0,10),localStorage.setItem(f.RECENT_PATTERNS,JSON.stringify(t))}function K(o){let t=w();t=t.filter(e=>e!==o),localStorage.setItem(f.RECENT_PATTERNS,JSON.stringify(t))}function w(){try{const o=localStorage.getItem(f.RECENT_PATTERNS);return o?JSON.parse(o):[]}catch{return[]}}class Y{constructor(){this.settings=V(),this.currentPattern=new E,this.currentFinger=1,this.currentHand="right",this.fingeringMode=!1,this.handprintMode=!1,this.handprintCaptures=[],this.handprintCaptureHand="right",this.savedHandprints=this.settings.handprints||[],this.gridElement=document.getElementById("grid"),this.gridRenderer=new _(this.gridElement),this.initUI(),this.loadStoredSettings(),this.updatePatternMetadata(),this.updateHandprintList(),this.render()}initUI(){var r,a,l,d,u,m,v,y;document.querySelectorAll('input[name="ori"]').forEach(c=>{c.addEventListener("change",()=>{this.settings.orientation=c.value,this.render(),p(this.settings)})}),document.querySelectorAll('input[name="lab"]').forEach(c=>{c.addEventListener("change",()=>{this.settings.labelMode=c.value,this.render(),p(this.settings)})}),document.getElementById("key").addEventListener("change",()=>{this.updatePatternMetadata(),this.render(),this.updateMIDIHoldIfActive()}),document.getElementById("set").addEventListener("change",c=>{const h=c.target.value==="custom";document.getElementById("customPC").disabled=!h,this.updatePatternMetadata(),this.render(),this.updateMIDIHoldIfActive()}),document.getElementById("customPC").addEventListener("input",()=>{this.render(),this.updateMIDIHoldIfActive()}),document.getElementById("baseMidi").addEventListener("input",c=>{this.settings.baseMidi=parseInt(c.target.value),this.render(),this.updateMIDIHoldIfActive(),p(this.settings)}),document.getElementById("fingeringMode").addEventListener("change",c=>{this.fingeringMode=c.target.checked,document.getElementById("fingeringModeInfo").style.display=this.fingeringMode?"block":"none",document.querySelectorAll(".finger-btn").forEach(h=>{h.disabled=!this.fingeringMode}),this.render()}),document.getElementById("fingeringHand").addEventListener("change",c=>{this.currentHand=c.target.value});for(let c=1;c<=5;c++)document.getElementById(`fingBtn${c}`).addEventListener("click",()=>{this.currentFinger=c,this.updateFingerButtonState()});document.addEventListener("keydown",c=>{this.fingeringMode&&c.key>="1"&&c.key<="5"&&(this.currentFinger=parseInt(c.key),this.updateFingerButtonState())}),document.getElementById("clearFingerings").addEventListener("click",()=>{this.currentPattern.clearAll(),this.render()}),document.getElementById("suggestFingerings").addEventListener("click",()=>{this.suggestFingerings()}),document.getElementById("savePattern").addEventListener("click",()=>this.saveCurrentPattern()),document.getElementById("loadPattern").addEventListener("change",c=>{c.target.value&&this.loadPatternByName(c.target.value)}),document.getElementById("deletePattern").addEventListener("click",()=>this.deleteCurrentPattern()),document.getElementById("exportPattern").addEventListener("click",()=>this.exportPattern()),document.getElementById("importPatternBtn").addEventListener("click",()=>{document.getElementById("importPattern").click()}),document.getElementById("importPattern").addEventListener("change",c=>this.importPattern(c)),document.getElementById("enableMidi").addEventListener("click",()=>this.initMIDI()),document.getElementById("midiDevice").addEventListener("change",c=>{c.target.value&&(g.selectOutputDevice(c.target.value),this.updateMIDIStatus())});const t=document.getElementById("midiHoldDuration"),e=document.getElementById("holdDurationValue");t==null||t.addEventListener("input",c=>{const h=parseInt(c.target.value);e.textContent=`${(h/1e3).toFixed(1)}s`,g.setHoldDuration(h),this.settings.midiHoldDuration=h,p(this.settings)});const n=document.getElementById("midiOctaveRange"),i=document.getElementById("octaveRangeValue");n==null||n.addEventListener("input",c=>{const h=parseInt(c.target.value);i.textContent=h===0?"0 (none)":`¬±${h}`,g.setOctaveRange(h),this.settings.midiOctaveRange=h,p(this.settings)});const s=document.getElementById("midiHoldToggle");s==null||s.addEventListener("change",c=>{c.target.checked?(g.enableHold(),this.sendHighlightedNotes()):g.disableHold()}),(r=document.getElementById("midiSendHighlighted"))==null||r.addEventListener("click",()=>{this.sendHighlightedNotes()}),(a=document.getElementById("analyzeErgo"))==null||a.addEventListener("click",()=>{this.analyzeErgonomics()}),(l=document.getElementById("handSize"))==null||l.addEventListener("change",c=>{const h=c.target.value;I.setHandSize(h),this.settings.handSize=h,p(this.settings)}),(d=document.getElementById("selectLeftHand"))==null||d.addEventListener("click",()=>{this.selectHandForCapture("left")}),(u=document.getElementById("selectRightHand"))==null||u.addEventListener("click",()=>{this.selectHandForCapture("right")}),(m=document.getElementById("startHandprintCapture"))==null||m.addEventListener("click",()=>{this.startHandprintCapture()}),(v=document.getElementById("exportHandprints"))==null||v.addEventListener("click",()=>{this.exportHandprints()}),(y=document.getElementById("fingeringType"))==null||y.addEventListener("change",c=>{this.settings.fingeringType=c.target.value,p(this.settings)}),this.gridRenderer.setPadClickHandler((c,h,x,X)=>{this.handprintMode?this.handleHandprintClick(c,h):this.fingeringMode?this.handleFingeringClick(c,h):g.playNote(x)})}loadStoredSettings(){document.querySelector(`input[name="ori"][value="${this.settings.orientation}"]`).checked=!0,document.querySelector(`input[name="lab"][value="${this.settings.labelMode}"]`).checked=!0,document.getElementById("baseMidi").value=this.settings.baseMidi;const t=document.getElementById("midiHoldDuration");t&&(t.value=this.settings.midiHoldDuration,document.getElementById("holdDurationValue").textContent=`${(this.settings.midiHoldDuration/1e3).toFixed(1)}s`,g.setHoldDuration(this.settings.midiHoldDuration));const e=document.getElementById("midiOctaveRange");if(e){e.value=this.settings.midiOctaveRange;const i=this.settings.midiOctaveRange;document.getElementById("octaveRangeValue").textContent=i===0?"0 (none)":`¬±${i}`,g.setOctaveRange(i)}const n=document.getElementById("handSize");n&&(n.value=this.settings.handSize,I.setHandSize(this.settings.handSize)),this.updatePatternList()}render(){this.gridRenderer.setOrientation(this.settings.orientation),this.gridRenderer.setLabelMode(this.settings.labelMode),this.gridRenderer.setBaseMidi(this.settings.baseMidi),this.gridRenderer.setHighlightedPCs(this.getHighlightedPCs()),this.gridRenderer.setFingeringPattern(this.currentPattern),this.gridRenderer.setFingeringMode(this.fingeringMode),this.gridRenderer.render()}getHighlightedPCs(){const t=document.getElementById("set").value;if(t==="custom"){const e=document.getElementById("customPC").value;return F(e)}else{const e=document.getElementById("key").value;return R(e,t)}}handleFingeringClick(t,e){const n=this.currentPattern.getFingering(t,e);n&&n.hand===this.currentHand&&n.finger===this.currentFinger?this.currentPattern.removeFingering(t,e):this.currentPattern.setFingering(t,e,this.currentHand,this.currentFinger),this.render()}updateFingerButtonState(){for(let t=1;t<=5;t++){const e=document.getElementById(`fingBtn${t}`);e.style.opacity=t===this.currentFinger?"1":"0.5"}}suggestFingerings(){const t=this.getHighlightedPCs();if(t.size===0){alert("No notes highlighted. Please select a key and scale/chord first.");return}const e=[];for(let r=0;r<11;r++)for(let a=0;a<(r%2===0?6:5);a++){const l=r===0?a:(r%2===1?4:3)*r+a,u=(this.settings.baseMidi+l)%12;t.has(u)&&e.push({row:r,col:a})}if(e.length===0){alert("No pads match the selected notes in the current range.");return}const n=document.getElementById("fingeringHand").value,i=I.suggestFingerings(e,n,this.settings.baseMidi);this.currentPattern.getPadsForHand(n).forEach(r=>{this.currentPattern.removeFingering(r.row,r.col)}),i.forEach(r=>{this.currentPattern.setFingering(r.row,r.col,r.hand,r.finger)}),this.render(),alert(`Suggested fingerings for ${i.length} pads (${n} hand)`)}saveCurrentPattern(){const t=document.getElementById("patternName").value.trim();if(!t){alert("Please enter a pattern name");return}const e={...this.currentPattern.toJSON(),key:document.getElementById("key").value,set:document.getElementById("set").value,baseMidi:this.settings.baseMidi};J(t,e),this.updatePatternList(),document.getElementById("patternName").value="",alert(`Pattern "${t}" saved!`)}loadPatternByName(t){const e=q(t);if(!e){alert(`Pattern "${t}" not found`);return}this.currentPattern=E.fromJSON(e),document.getElementById("key").value=e.key,document.getElementById("set").value=e.set,this.settings.baseMidi=e.baseMidi,document.getElementById("baseMidi").value=e.baseMidi,this.render()}deleteCurrentPattern(){const t=document.getElementById("loadPattern").value;if(!t){alert("Please select a pattern to delete");return}confirm(`Delete pattern "${t}"?`)&&(U(t),this.updatePatternList(),document.getElementById("loadPattern").value="")}exportPattern(){if(this.currentPattern.fingerings.size===0){alert("No fingerings to export. Create a fingering pattern first.");return}this.updatePatternMetadata();const t=document.getElementById("patternName");t.value.trim()&&(this.currentPattern.name=t.value.trim());let e;if(this.currentPattern.name==="Untitled"||!this.currentPattern.name.trim()){const a=this.currentPattern.metadata.key||"C",l=this.currentPattern.metadata.setType||"major",d=this.currentHand||"right",u=new Date().toISOString().slice(11,19).replace(/:/g,"");e=`${a}_${l}_${d}_${u}`}else e=this.currentPattern.name;const n=JSON.stringify(this.currentPattern.toJSON(),null,2),i=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(i),r=document.createElement("a");r.href=s,r.download=`${e.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s),alert(`Exported "${this.currentPattern.name}" to JSON file`)}importPattern(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=i=>{try{const s=JSON.parse(i.target.result),r=E.fromJSON(s);this.currentPattern=r,document.getElementById("patternName").value=r.name,this.render(),alert(`Imported "${r.name}" with ${r.fingerings.size} fingerings`),t.target.value=""}catch(s){alert(`Error importing file: ${s.message}`),console.error("Import error:",s)}},n.readAsText(e)}updatePatternList(){const t=document.getElementById("loadPattern"),e=G();t.innerHTML='<option value="">-- Select Pattern --</option>',e.forEach(n=>{const i=document.createElement("option");i.value=n,i.textContent=n,t.appendChild(i)})}async initMIDI(){try{await g.init(),this.updateMIDIDeviceList(),this.updateMIDIStatus()}catch(t){this.updateMIDIStatus(t.message)}}updateMIDIDeviceList(){const t=document.getElementById("midiDevice"),e=g.getOutputDevices();t.innerHTML='<option value="">-- Select device --</option>',e.forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.name,t.appendChild(i)}),t.disabled=e.length===0}updateMIDIStatus(t=null){const e=g.getStatus(),n=document.getElementById("midiStatus");t?(n.textContent=`Error: ${t}`,n.className="error-box"):e.isSupported?e.isInitialized?e.hasDevice?(n.textContent=`Connected: ${e.deviceName}`,n.className="success-box"):(n.textContent="MIDI ready - select a device",n.className="info-box"):(n.textContent="MIDI not initialized",n.className="warning-box"):(n.textContent="WebMIDI not supported (use Chrome/Brave/Edge)",n.className="warning-box")}sendHighlightedNotes(){const t=this.getHighlightedPCs(),e=[];for(let n=0;n<39;n++){const i=this.settings.baseMidi+n,s=i%12;t.has(s)&&e.push(i)}g.playChord(e,100,null,20)}updatePatternMetadata(){const t=document.getElementById("key").value,e=document.getElementById("set").value;this.currentPattern.metadata.key=t,this.currentPattern.metadata.setType=e,this.currentPattern.metadata.modifiedAt=Date.now()}updateMIDIHoldIfActive(){const t=document.getElementById("midiHoldToggle");t&&t.checked&&g.getStatus().isHolding&&(g.releaseAllNotes(),this.sendHighlightedNotes())}analyzeErgonomics(){const t=I.analyzePattern(this.currentPattern),e=document.getElementById("ergoResult");e&&(e.innerHTML=`
        <div class="score-display">
          <div class="score-label">Ergonomic Score</div>
          <div class="score-value">${t.score}</div>
          <div class="score-recommendation">${t.recommendation}</div>
        </div>
        ${t.issues.length>0?`
          <h4>Issues Found:</h4>
          <ul class="issue-list">
            ${t.issues.map(n=>`<li class="issue-item">${this.formatIssue(n)}</li>`).join("")}
          </ul>
        `:'<div class="success-box">No ergonomic issues found!</div>'}
      `)}formatIssue(t){switch(t.type){case"excessive_stretch":return`Excessive stretch between fingers ${t.fingers.join(" and ")} (${t.hand} hand)`;case"uncomfortable_stretch":return`Uncomfortable stretch between fingers ${t.fingers.join(" and ")} (${t.hand} hand)`;case"finger_crossing":return`Possible finger crossing: fingers ${t.fingers.join(" and ")} (${t.hand} hand)`;default:return JSON.stringify(t)}}selectHandForCapture(t){this.handprintCaptureHand=t;const e=document.getElementById("selectLeftHand"),n=document.getElementById("selectRightHand");t==="left"?(e==null||e.classList.add("active"),n==null||n.classList.remove("active")):(n==null||n.classList.add("active"),e==null||e.classList.remove("active"))}async startHandprintCapture(){if(!g.getStatus().isInitialized)try{await g.init(),this.updateMIDIDeviceList(),this.updateMIDIStatus()}catch(n){alert(`Cannot enable MIDI: ${n.message}

Fallback: You can click pads on the grid instead.`)}this.handprintMode=!0,this.handprintCaptures=[];const t=document.getElementById("handprintCaptureStatus");t&&(t.innerHTML=`
        <div style="background:#334; padding:12px; border-radius:4px; margin-top:8px;">
          <strong>Capture Active</strong><br/>
          Place your <strong>${this.handprintCaptureHand}</strong> hand on the device.<br/>
          Press pads in order: <strong>üëç 1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5 ü§ô</strong>
          <div style="margin-top:8px; font-size:1.2em; color:#6af;">
            <strong>Captured: ${this.handprintCaptures.length}/5</strong>
          </div>
        </div>
      `),g.setNoteHandler((n,i)=>{this.handprintMode&&i>0&&this.handleHandprintMidiNote(n)});const e=document.getElementById("startHandprintCapture");e.textContent="Cancel Capture",e.style.background="#c44"}handleHandprintMidiNote(t){if(this.handprintCaptures.length>=5)return;const e=t-this.settings.baseMidi,n=Math.floor(e/6),i=e%6;this.handprintCaptures.push({row:n,col:i,midiNote:t,finger:this.handprintCaptures.length+1});const s=document.getElementById("handprintCaptureStatus");if(s){const r=s.querySelector("div:last-child strong");r&&(r.textContent=`Captured: ${this.handprintCaptures.length}/5`)}this.render(),this.handprintCaptures.length===5&&this.finishHandprintCapture()}handleHandprintClick(t,e){if(this.handprintCaptures.length>=5)return;this.handprintCaptures.push({row:t,col:e,finger:this.handprintCaptures.length+1});const n=document.getElementById("handprintCaptureStatus");if(n){const i=n.querySelector("div:last-child strong");i&&(i.textContent=`Captured: ${this.handprintCaptures.length}/5 (click)`)}this.render(),this.handprintCaptures.length===5&&this.finishHandprintCapture()}finishHandprintCapture(){this.handprintMode=!1,g.setNoteHandler(null);const t={};for(let r=0;r<5;r++)for(let a=r+1;a<5;a++){const l=this.handprintCaptures[r],d=this.handprintCaptures[a],u=Math.sqrt(Math.pow(d.row-l.row,2)+Math.pow(d.col-l.col,2)),m=`${r+1}-${a+1}`;t[m]=u}const e=`${this.handprintCaptureHand}_${Date.now()}`,n={id:e,hand:this.handprintCaptureHand,positions:this.handprintCaptures,measurements:t,capturedAt:Date.now()};this.savedHandprints.push(n),this.settings.handprints=this.savedHandprints,p(this.settings),this.updateHandprintList();const i=document.getElementById("handprintCaptureStatus");i&&(i.innerHTML=`
        <div style="background:#243; padding:12px; border-radius:4px; margin-top:8px; color:#6f6;">
          ‚úì Handprint Saved!<br/>
          <strong>ID:</strong> ${e}<br/>
          <strong>Hand:</strong> ${this.handprintCaptureHand}<br/>
          <strong>Measurements:</strong> ${Object.keys(t).length} finger pairs
        </div>
      `,setTimeout(()=>{i.innerHTML=""},3e3));const s=document.getElementById("startHandprintCapture");s.textContent="Start Capture",s.style.background="",this.render()}updateHandprintList(){const t=document.getElementById("handprintList"),e=document.getElementById("exportHandprints");if(this.savedHandprints.length===0){t.innerHTML='<div style="opacity:0.7;">No handprints captured yet.</div>',e.style.display="none";return}t.innerHTML=this.savedHandprints.map(n=>{const s=new Date(n.capturedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return`
        <div class="handprint-item ${n.hand}">
          <strong>${n.hand.toUpperCase()}</strong> hand - ${s}<br/>
          <span style="font-size:0.9em; opacity:0.7;">ID: ${n.id}</span>
        </div>
      `}).join(""),e.style.display="block"}exportHandprints(){if(this.savedHandprints.length===0){alert("No handprints to export.");return}const t={exportedAt:new Date().toISOString(),handprints:this.savedHandprints},e=JSON.stringify(t,null,2),n=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`handprints_${new Date().toISOString().slice(0,19).replace(/:/g,"")}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),alert(`Exported ${this.savedHandprints.length} handprints to JSON file.`)}}document.addEventListener("DOMContentLoaded",()=>{window.app=new Y});
